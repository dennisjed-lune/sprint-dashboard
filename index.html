<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Dashboard - Lune</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0B1220;
            color: #E6EDF6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #111827;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid #2A3441;
        }

        .header {
            background: linear-gradient(135deg, #1F2937 0%, #111827 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            border-bottom: 2px solid #3B82F6;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            background: linear-gradient(135deg, #3B82F6 0%, #22D3EE 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.8;
            color: #9AA4B2;
        }

        .cycle-selector {
            position: absolute;
            top: 40px;
            right: 40px;
            background: rgba(59, 130, 246, 0.1);
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid #3B82F6;
            backdrop-filter: blur(10px);
        }

        .cycle-selector label {
            color: #3B82F6;
            font-weight: 600;
            margin-right: 10px;
            font-size: 0.9em;
        }

        .cycle-selector select {
            padding: 8px 15px;
            border: 2px solid #3B82F6;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            color: #3B82F6;
            cursor: pointer;
            background: #1F2937;
            transition: all 0.3s;
        }

        .cycle-selector select:hover {
            border-color: #22D3EE;
            color: #22D3EE;
        }

        .cycle-selector select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .content {
            padding: 40px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: #1F2937;
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid #2A3441;
            transition: all 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            border-color: #3B82F6;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }

        .metric-card h3 {
            font-size: 0.9em;
            opacity: 0.7;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #9AA4B2;
        }

        .metric-card .value {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #3B82F6 0%, #22D3EE 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-card .subvalue {
            font-size: 0.95em;
            opacity: 0.7;
            color: #9AA4B2;
        }

        .section {
            margin-bottom: 50px;
        }

        .section h2 {
            font-size: 1.8em;
            margin-bottom: 25px;
            color: #3B82F6;
            border-bottom: 2px solid #3B82F6;
            padding-bottom: 10px;
        }

        .bar-chart {
            background: #1F2937;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #2A3441;
        }

        .bar-chart h3 {
            margin-bottom: 20px;
            color: #E6EDF6;
            font-size: 1.3em;
        }

        .pie-chart-container {
            background: #1F2937;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #2A3441;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pie-chart-container h3 {
            margin-bottom: 20px;
            color: #E6EDF6;
            font-size: 1.3em;
            width: 100%;
            text-align: center;
        }

        .pie-chart {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            position: relative;
            margin: 0 auto;
        }

        .pie-legend {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .pie-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pie-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .pie-legend-label {
            color: #9AA4B2;
            font-size: 0.9em;
        }

        .pie-legend-value {
            color: #E6EDF6;
            font-weight: 600;
        }

        .bar-item {
            margin-bottom: 15px;
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.95em;
            font-weight: 600;
            color: #9AA4B2;
        }

        .bar-bg {
            background: #0B1220;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 1px solid #2A3441;
        }

        .bar-fill {
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            padding-left: 15px;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .bar-fill.green {
            background: linear-gradient(90deg, #22C55E 0%, #16A34A 100%);
        }

        .bar-fill.orange {
            background: linear-gradient(90deg, #F59E0B 0%, #D97706 100%);
        }

        .bar-fill.blue {
            background: linear-gradient(90deg, #3B82F6 0%, #2563EB 100%);
        }

        .bar-fill.cyan {
            background: linear-gradient(90deg, #22D3EE 0%, #06B6D4 100%);
        }

        .table-container {
            overflow-x: auto;
            background: #1F2937;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #2A3441;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #111827;
            border-radius: 10px;
            overflow: hidden;
        }

        thead {
            background: #1F2937;
            color: #3B82F6;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #2A3441;
            color: #E6EDF6;
        }

        tbody tr:hover {
            background: #1F2937;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9AA4B2;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .cycle-selector {
                position: static;
                margin-top: 20px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="cycle-selector">
                <label for="cycle-select">üìä Select Sprint:</label>
                <select id="cycle-select" onchange="loadCycleData()">
                    <option value="cycle42">Cycle 42</option>
                    <option value="cycle41">Cycle 41</option>
                    <option value="cycle40">Cycle 40</option>
                    <option value="cycle39">Cycle 39</option>
                </select>
            </div>
            <h1>üöÄ Sprint Dashboard</h1>
            <p id="cycle-info">Tech Team Performance</p>
        </div>

        <div class="content" id="content">
            <p class="loading">Loading dashboard data...</p>
        </div>
    </div>

    <script>
        let currentData = null;

        async function loadCycleData() {
            const cycleSelect = document.getElementById('cycle-select');
            const selectedCycle = cycleSelect.value;
            
            document.getElementById('content').innerHTML = '<p class="loading">Loading data...</p>';

            try {
                const response = await fetch(`${selectedCycle}.json`);
                if (!response.ok) throw new Error('Failed to load data');
                
                const data = await response.json();
                currentData = data;
                
                const cycleName = data[0] ? data[0]['Cycle Name'] : selectedCycle.replace('cycle', 'Cycle ');
                document.getElementById('cycle-info').textContent = `${cycleName} ¬∑ Tech Team Performance`;
                
                render();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('content').innerHTML = `
                    <p class="loading" style="color: #EF4444;">
                        ‚ùå Error loading ${selectedCycle} data. Make sure the JSON file is uploaded to GitHub.
                    </p>
                `;
            }
        }

        function processData() {
            const metrics = {
                totalIssues: currentData.length,
                completedIssues: 0,
                totalPoints: 0,
                completedPoints: 0
            };

            const engineerStats = {};
            const statusCounts = {};
            const priorityCounts = {};

            const targetLabels = ['BE', 'QA', 'FE', 'Devops', 'Mobile', 'AI'];
            const labelIssues = {};
            const labelPoints = {};
            targetLabels.forEach(label => {
                labelIssues[label] = 0;
                labelPoints[label] = 0;
            });

            currentData.forEach(issue => {
                const status = issue.Status || 'Unknown';
                const points = parseInt(issue.Estimate) || 0;
                const assignee = issue.Assignee || 'Unassigned';
                const priority = issue.Priority || 'No priority';

                // Count all statuses
                statusCounts[status] = (statusCounts[status] || 0) + 1;
                
                // Always include "No priority" in counts
                priorityCounts[priority] = (priorityCounts[priority] || 0) + 1;

                if (issue.Labels) {
                    issue.Labels.split(',').forEach(label => {
                        const l = label.trim();
                        if (targetLabels.includes(l)) {
                            labelIssues[l] = (labelIssues[l] || 0) + 1;
                            labelPoints[l] = (labelPoints[l] || 0) + points;
                        }
                    });
                }

                if (status === 'Done') {
                    metrics.completedIssues++;
                    metrics.completedPoints += points;
                }

                metrics.totalPoints += points;

                const excludeEngineers = ['saad@lunedata.io', 'dennis@lunedata.io', 'ahmedelzubair@lunedata.io'];
                if (!excludeEngineers.includes(assignee) && assignee !== 'Unassigned') {
                    if (!engineerStats[assignee]) {
                        engineerStats[assignee] = {
                            total: 0,
                            completed: 0,
                            inProgress: 0,
                            todo: 0,
                            totalPoints: 0,
                            completedPoints: 0
                        };
                    }

                    engineerStats[assignee].total++;
                    engineerStats[assignee].totalPoints += points;

                    if (status === 'Done') {
                        engineerStats[assignee].completed++;
                        engineerStats[assignee].completedPoints += points;
                    } else if (status === 'In Progress' || status === 'In Review' || status === 'QA') {
                        engineerStats[assignee].inProgress++;
                    } else if (status === 'Todo') {
                        engineerStats[assignee].todo++;
                    }
                }
            });

            return { metrics, engineerStats, statusCounts, priorityCounts, labelIssues, labelPoints };
        }

        function createPieChart(title, total, completed, label1, label2) {
            const remaining = total - completed;
            const completedPercent = (completed / total * 100).toFixed(1);
            const remainingPercent = (remaining / total * 100).toFixed(1);
            
            // Create conic gradient for pie chart
            const completedDeg = (completed / total) * 360;
            const gradient = `conic-gradient(
                #22C55E 0deg ${completedDeg}deg,
                #2A3441 ${completedDeg}deg 360deg
            )`;

            return `
                <div class="pie-chart-container">
                    <h3>${title}</h3>
                    <div class="pie-chart" style="background: ${gradient}">
                    </div>
                    <div class="pie-legend">
                        <div class="pie-legend-item">
                            <div class="pie-legend-color" style="background: #22C55E;"></div>
                            <span class="pie-legend-label">${label1}:</span>
                            <span class="pie-legend-value">${completed} (${completedPercent}%)</span>
                        </div>
                        <div class="pie-legend-item">
                            <div class="pie-legend-color" style="background: #2A3441;"></div>
                            <span class="pie-legend-label">${label2}:</span>
                            <span class="pie-legend-value">${remaining} (${remainingPercent}%)</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function createBarChart(title, data, colorClass = 'blue') {
            const max = Math.max(...Object.values(data));
            if (max === 0) return '<div class="bar-chart"><h3>' + title + '</h3><p>No data</p></div>';

            let html = `<div class="bar-chart"><h3>${title}</h3>`;

            Object.entries(data)
                .sort((a, b) => b[1] - a[1])
                .forEach(([label, value]) => {
                    const percentage = (value / max) * 100;
                    html += `
                        <div class="bar-item">
                            <div class="bar-label">
                                <span>${label}</span>
                                <span>${value}</span>
                            </div>
                            <div class="bar-bg">
                                <div class="bar-fill ${colorClass}" style="width: ${percentage}%">
                                    ${percentage > 20 ? value : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

            html += '</div>';
            return html;
        }

        function createCombinedEngineerChart(engineerStats) {
            const engineers = Object.entries(engineerStats)
                .sort((a, b) => b[1].completed - a[1].completed);

            if (engineers.length === 0) return '<div class="bar-chart"><h3>Engineer Performance</h3><p>No data</p></div>';

            const maxIssues = Math.max(...engineers.map(([, stats]) => stats.completed));
            const maxPoints = Math.max(...engineers.map(([, stats]) => stats.completedPoints));

            let html = `<div class="bar-chart"><h3>Completed Issues & Points per Engineer</h3>`;

            engineers.forEach(([name, stats]) => {
                const shortName = name.split('@')[0];
                const issuePercentage = (stats.completed / maxIssues) * 100;
                const pointsPercentage = (stats.completedPoints / maxPoints) * 100;

                html += `
                    <div class="bar-item">
                        <div class="bar-label">
                            <span><strong>${shortName}</strong></span>
                            <span>${stats.completed} issues / ${stats.completedPoints} points</span>
                        </div>
                        <div class="bar-bg" style="margin-bottom: 5px;">
                            <div class="bar-fill green" style="width: ${issuePercentage}%">
                                ${issuePercentage > 20 ? stats.completed + ' issues' : ''}
                            </div>
                        </div>
                        <div class="bar-bg">
                            <div class="bar-fill cyan" style="width: ${pointsPercentage}%">
                                ${pointsPercentage > 20 ? stats.completedPoints + ' pts' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        function render() {
            const { metrics, engineerStats, statusCounts, priorityCounts, labelIssues, labelPoints } = processData();

            const completionRate = ((metrics.completedIssues / metrics.totalIssues) * 100).toFixed(1);
            const pointsCompletionRate = metrics.totalPoints > 0
                ? ((metrics.completedPoints / metrics.totalPoints) * 100).toFixed(1)
                : 0;

            // Filter out "Done" from status counts for leftover chart
            const leftoverStatuses = {};
            Object.entries(statusCounts).forEach(([status, count]) => {
                if (status !== 'Done') {
                    leftoverStatuses[status] = count;
                }
            });

            let html = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>Total Issues</h3>
                        <div class="value">${metrics.totalIssues}</div>
                        <div class="subvalue">In sprint</div>
                    </div>
                    <div class="metric-card">
                        <h3>‚úÖ Completed Issues</h3>
                        <div class="value">${metrics.completedIssues}</div>
                        <div class="subvalue">${completionRate}% of total</div>
                    </div>
                    <div class="metric-card">
                        <h3>üéØ Total Points</h3>
                        <div class="value">${metrics.totalPoints}</div>
                        <div class="subvalue">In sprint</div>
                    </div>
                    <div class="metric-card">
                        <h3>‚úÖ Completed Points</h3>
                        <div class="value">${metrics.completedPoints}</div>
                        <div class="subvalue">${pointsCompletionRate}% of total</div>
                    </div>
                </div>

                <div class="section">
                    <h2>üìä Completion Overview</h2>
                    <div class="grid-2">
                        ${createPieChart('Total Issues', metrics.totalIssues, metrics.completedIssues, 'Completed', 'Remaining')}
                        ${createPieChart('Total Points', metrics.totalPoints, metrics.completedPoints, 'Completed', 'Remaining')}
                    </div>
                </div>

                <div class="section">
                    <h2>üìã Status & Priority</h2>
                    <div class="grid-2">
                        ${createBarChart('Leftover Issues by Status - At End of Sprint', leftoverStatuses, 'blue')}
                        ${createBarChart('Issues by Priority', priorityCounts, 'orange')}
                    </div>
                </div>

                <div class="section">
                    <h2>üè∑Ô∏è Work Distribution by Label</h2>
                    <div class="grid-2">
                        ${createBarChart('Issues by Label', labelIssues, 'blue')}
                        ${createBarChart('Points by Label', labelPoints, 'green')}
                    </div>
                </div>

                <div class="section">
                    <h2>üë• Engineer Performance</h2>
                    ${createCombinedEngineerChart(engineerStats)}
                </div>

                <div class="section">
                    <h2>üìä Engineer Details</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Engineer</th>
                                    <th>Total</th>
                                    <th>Completed</th>
                                    <th>In Progress</th>
                                    <th>Todo</th>
                                    <th>Points</th>
                                    <th>Completed Pts</th>
                                    <th>Rate</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            const engineers = Object.entries(engineerStats)
                .sort((a, b) => b[1].total - a[1].total);

            engineers.forEach(([name, stats]) => {
                const rate = ((stats.completed / stats.total) * 100).toFixed(1);
                const shortName = name.split('@')[0];
                html += `
                    <tr>
                        <td><strong>${shortName}</strong></td>
                        <td>${stats.total}</td>
                        <td>${stats.completed}</td>
                        <td>${stats.inProgress}</td>
                        <td>${stats.todo}</td>
                        <td>${stats.totalPoints}</td>
                        <td>${stats.completedPoints}</td>
                        <td><strong>${rate}%</strong></td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('content').innerHTML = html;
        }

        window.addEventListener('load', loadCycleData);
    </script>
</body>
</html>